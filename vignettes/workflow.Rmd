---
title: "Workflow"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{rater workflow}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  comment = "#>"
)
```

## What is rater?

The **rater** package is designed to allow easy fitting and analysis of
Bayesian models of categorical data annotation using
[Stan](http://mc-stan.org/). Here we demonstrate the basic workflow for using
the package.

## Data

We will use the *anesthesia* data set taken from the paper *Maximum Likelihood
Estimation of Observer Error-Rates Using the EM Algorithm* by A. P. Dawid and
A. M. Skene, the paper which introduced the type of models used in this
package. This dataset is included in **rater**. Run:

```{r}
# load the rater package
library(rater)

data("anesthesia")
```

to load the data. The data comes in the form of a numeric matrix with three columns
`item_index`, `rater_index` and `rating`. In the nomenclature of the package we would 
descibe this as *long* data. (For further information about data types see: __link__).
We need to annotate this data as being long_data before we can use it for mode fitting.
We do this using the command:

```{r}
anesthesia <- long_data(anesthesia)
```

## mcmc()

The core function of the **rater** package is the `mcmc()` function which fits a model 
to given data. This function has two arguments: `data`, data annotated as being in 
an appropriate format and `model`, which specifies the model you would like to fit. 

Currently the we support Multinomial, Dawid and Skene and Hierachical Dawid and Skene models
in the package. Models are specifed as a function with the name of the model you woudl 
like to fit. 

```{r}
# fit the model using MCMC via Stan 
fit <- mcmc(anesthesia, dawid_skene(), iter = 500, chains = 1)
```

You will see the normal progress output you get whenever **Stan** is sampling.
Note that all models are compiled when the package is installed, rather than at
runtime, meaning that you will not need to wait for a model to be compiled when
running analyses using the **rater** package. [^1]

If you would like to change the prior parameters of the models you can do this 
by passing appropriate paraemters to the model function. For example to fit the 
dawid and skene model with prior parameter $\alpha$ `= c(4, 4, 4, 4)` you would run:

```{r, eval = FALSE}
fit <- mcmc(anesthesia, dawid_skene(alpha = c(4, 4, 4, 4)))
```

## plot()

Having fit the Dawid and Skene model to the data we can now plot and extract key 
parameter estimates from the model. 

To plot the population prevalence estimates (the parameter $\pi$ in the model) we run:

```{r, fig.width=6, fig.height=4}
plot(fit, type = "pi") # or plot(fit, type = "prevalence")
```

To plot the probalistic confusion matrices of the raters (the parameter $\theta$ in the model) we run:

```{r, fig.width=6, fig.height=4}
plot(fit, type = "theta") # or plot(fit, type = "raters")
```

To plot the latent class estimates (the parameter $z$ in the model) we run:

```{r, fig.width=6, fig.height=8}
plot(fit, type = "z") # or plot(fit, "latent_class")
```

For a discussion of what these parameters in the model represent, please see the vignette __models__.

## extract

Similarly, we can extract all of the estimates used to make these plots for further 
processing with the `extract` function:

```{r, eval = FALSE}
extract_pi(fit)

extract_theta(fit)

extract_z(fit)
```

[^1]: In the example above we specified **Stan** to only run 1 chain
with 500 iterations in order to speed up the creation of this vignette and
reduce the volume of output. In general, we recommend running `mcmc()` using
the **Stan** sampling defaults, which will be used if you only specify the
`data` and `model` arguments in `mcmc()` i.e.

```{r, eval = FALSE}
fit <- mcmc(anesthesia, dawid_skene())
```
